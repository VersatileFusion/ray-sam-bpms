import{y as u,N as g}from"./index-B1RxePN7.js";const o={async getRequests(t={}){const e={...t};return Array.isArray(e.conditions)&&(e.conditions=JSON.stringify(e.conditions)),e.conditions==="[]"&&delete e.conditions,(await u.get("/requests",{params:e})).data},async searchRequests(t){return(await u.get("/requests/search",{params:t})).data},async getRequest(t){return(await u.get(`/requests/${t}`)).data},async createRequest(t){return(await u.post("/requests",t)).data},async updateRequest(t,e){return(await u.put(`/requests/${t}`,e)).data},async getRequestHistory(t){return(await u.get(`/requests/${t}/history`)).data},async addComment(t,e){return(await u.post(`/requests/${t}/comments`,{comment:e})).data},async uploadAttachment(t,e){const r=new FormData;return r.append("file",e),(await u.post(`/requests/${t}/attachments`,r,{headers:{"Content-Type":"multipart/form-data"}})).data},async assignRequest(t,e){return(await u.post(`/requests/${t}/assign`,{userId:e})).data},async bulkUpdate(t,e){return(await u.post("/requests/bulk/update",{ids:t,updates:e})).data}},R=g("requests",{state:()=>({requests:[],currentRequest:null,loading:!1,error:null,pagination:null,lastParams:{},pendingUpdates:{}}),getters:{hasResults:t=>t.requests.length>0},actions:{async fetchRequests(t={}){var e,r;this.loading=!0,this.error=null;try{this.lastParams={...t};const s=await o.getRequests(t);return Array.isArray(s)?(this.requests=s,this.pagination=null,s):s!=null&&s.success&&Array.isArray(s.data)?(this.requests=s.data,this.pagination=s.pagination||null,s.data):Array.isArray(s==null?void 0:s.data)?(this.requests=s.data,this.pagination=s.pagination||null,s.data):(this.requests=[],this.pagination=null,[])}catch(s){throw this.error=((r=(e=s.response)==null?void 0:e.data)==null?void 0:r.message)||"خطا در دریافت درخواست‌ها",this.requests=[],this.pagination=null,s}finally{this.loading=!1}},async fetchRequest(t){var e,r;this.loading=!0,this.error=null;try{const s=await o.getRequest(t);return this.currentRequest=s,s}catch(s){throw this.error=((r=(e=s.response)==null?void 0:e.data)==null?void 0:r.message)||"خطا در دریافت درخواست",s}finally{this.loading=!1}},async createRequest(t){var e,r;this.loading=!0,this.error=null;try{const s=await o.createRequest(t);return await this.fetchRequests(this.lastParams),s}catch(s){throw this.error=((r=(e=s.response)==null?void 0:e.data)==null?void 0:r.message)||"خطا در ثبت درخواست",s}finally{this.loading=!1}},async updateRequest(t,e){var c,h,l,d;this.loading=!0,this.error=null;const r={current:this.currentRequest?{...this.currentRequest}:null,list:[...this.requests]},s={...e,_id:t},a=this.requests.findIndex(i=>i._id===t);a!==-1&&this.requests.splice(a,1,{...this.requests[a],...s}),((c=this.currentRequest)==null?void 0:c._id)===t&&(this.currentRequest={...this.currentRequest,...s}),this.pendingUpdates[t]=!0;try{const i=await o.updateRequest(t,e);return await this.fetchRequests(this.lastParams),((h=this.currentRequest)==null?void 0:h._id)===t&&(this.currentRequest=i),i}catch(i){throw this.requests=r.list,r.current&&(this.currentRequest=r.current),this.error=((d=(l=i.response)==null?void 0:l.data)==null?void 0:d.message)||"خطا در ویرایش درخواست",i}finally{this.loading=!1,delete this.pendingUpdates[t]}},async searchRequests(t){var e,r;this.loading=!0,this.error=null;try{return await o.searchRequests(t)}catch(s){throw this.error=((r=(e=s.response)==null?void 0:e.data)==null?void 0:r.message)||"خطا در جستجو",s}finally{this.loading=!1}},async assignRequest(t,e){var h,l,d,i,q,p;const r={list:[...this.requests],current:this.currentRequest?{...this.currentRequest}:null},s=((h=r.list.find(n=>n._id===t))==null?void 0:h.assignedTo)||null,a={assignedTo:{userId:e,name:"—"}},c=this.requests.findIndex(n=>n._id===t);c!==-1&&this.requests.splice(c,1,{...this.requests[c],...a}),((l=this.currentRequest)==null?void 0:l._id)===t&&(this.currentRequest={...this.currentRequest,...a}),this.pendingUpdates[t]=!0;try{const n=await o.assignRequest(t,e);return await this.fetchRequests(this.lastParams),((d=this.currentRequest)==null?void 0:d._id)===t&&(this.currentRequest={...this.currentRequest,assignedTo:((i=n==null?void 0:n.request)==null?void 0:i.assignedTo)||(n==null?void 0:n.assignedTo)||s}),n}catch(n){throw this.requests=r.list,r.current&&(this.currentRequest=r.current),this.error=((p=(q=n.response)==null?void 0:q.data)==null?void 0:p.message)||"خطا در اختصاص درخواست",n}finally{delete this.pendingUpdates[t]}},async addComment(t,e){var r,s;try{return await o.addComment(t,e)}catch(a){throw this.error=((s=(r=a.response)==null?void 0:r.data)==null?void 0:s.message)||"خطا در ثبت نظر",a}},async getRequestHistory(t){var e,r;try{return await o.getRequestHistory(t)}catch(s){throw this.error=((r=(e=s.response)==null?void 0:e.data)==null?void 0:r.message)||"خطا در دریافت تاریخچه",s}},async uploadAttachment(t,e){var r,s;try{return await o.uploadAttachment(t,e)}catch(a){throw this.error=((s=(r=a.response)==null?void 0:r.data)==null?void 0:s.message)||"خطا در آپلود فایل",a}}}});export{R as u};
