<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>پنل مدیریت</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.rtl.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn-font@v33.003/dist/font-face.css" rel="stylesheet">
  <style>
    :root {
      --primary: #1a237e;
      --secondary: #455a64;
      --success: #388e3c;
      --danger: #c62828;
      --warning: #f9a825;
      --info: #1976d2;
      --border: #e0e0e0;
      --bg: #f5f6fa;
      --card-bg: #fff;
      --text: #222;
      --muted: #6b7280;
    }

    body {
      background: var(--bg);
      min-height: 100vh;
      font-family: Vazirmatn, sans-serif !important;
      color: var(--text);
    }

    .admin-header {
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      color: #fff;
      padding: 2rem;
      margin-bottom: 2rem;
    }

    .glass-card {
      background: var(--card-bg);
      box-shadow: 0 2px 8px rgba(44, 62, 80, 0.06);
      border-radius: 0.75rem;
      border: 1px solid var(--border);
      padding: 2rem;
      margin-bottom: 2rem;
    }

    .badge-active {
      background: var(--success);
    }

    .badge-inactive {
      background: var(--muted);
    }
  </style>
</head>
<body>
  <div class="admin-header">
    <div class="container">
      <h1><i class="bi bi-shield-lock"></i> پنل مدیریت</h1>
      <p class="mb-0">مدیریت کاربران و تنظیمات سیستم</p>
    </div>
  </div>

  <div class="container">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <div>
        <button class="btn btn-primary" onclick="window.location.href='/'">
          <i class="bi bi-arrow-right"></i> بازگشت به صفحه اصلی
        </button>
      </div>
      <div>
        <button class="btn btn-success" onclick="showAddUserModal()">
          <i class="bi bi-plus-circle"></i> افزودن کاربر
        </button>
      </div>
    </div>

    <!-- Users Table -->
    <div class="glass-card">
      <h3><i class="bi bi-people"></i> کاربران سیستم</h3>
      <div class="table-responsive">
        <table class="table table-hover">
          <thead class="table-dark">
            <tr>
              <th>نام کاربری</th>
              <th>نام</th>
              <th>نقش</th>
              <th>وضعیت</th>
              <th>آخرین ورود</th>
              <th>عملیات</th>
            </tr>
          </thead>
          <tbody id="usersTableBody">
            <tr><td colspan="6" class="text-center">در حال بارگذاری...</td></tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- Audit Logs -->
    <div class="glass-card">
      <h3><i class="bi bi-journal-text"></i> گزارش فعالیت‌ها</h3>
      <div class="table-responsive">
        <table class="table table-sm">
          <thead class="table-secondary">
            <tr>
              <th>عملیات</th>
              <th>کاربر</th>
              <th>زمان</th>
              <th>جزئیات</th>
            </tr>
          </thead>
          <tbody id="auditLogsBody">
            <tr><td colspan="4" class="text-center">در حال بارگذاری...</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://unpkg.com/jalali-moment/dist/jalali-moment.browser.js"></script>
  <script>
    const API_BASE = window.location.hostname === 'localhost' 
      ? "http://localhost:3000" 
      : "https://ray-sam-bpms.onrender.com";

    let currentUser = null;

    // Check authentication and admin role
    async function checkAdmin() {
      try {
        const response = await fetch(`${API_BASE}/api/auth/me`, { credentials: 'include' });
        if (!response.ok) {
          window.location.href = '/login.html';
          return false;
        }
        const data = await response.json();
        currentUser = data.user;
        
        if (currentUser.role !== 'admin') {
          Swal.fire({
            icon: 'error',
            title: 'عدم دسترسی',
            text: 'شما دسترسی به پنل مدیریت ندارید'
          }).then(() => {
            window.location.href = '/';
          });
          return false;
        }
        return true;
      } catch (error) {
        window.location.href = '/login.html';
        return false;
      }
    }

    // Load users
    async function loadUsers() {
      try {
        const response = await fetch(`${API_BASE}/api/users`, { credentials: 'include' });
        const data = await response.json();
        
        const tbody = document.getElementById('usersTableBody');
        tbody.innerHTML = '';
        
        if (data.users && data.users.length > 0) {
          data.users.forEach(user => {
            const lastLogin = user.lastLogin 
              ? moment(user.lastLogin).locale('fa').fromNow()
              : 'هرگز';
            
            tbody.innerHTML += `
              <tr>
                <td>${user.username}</td>
                <td>${user.name}</td>
                <td><span class="badge bg-${user.role === 'admin' ? 'danger' : 'primary'}">${user.role === 'admin' ? 'مدیر' : 'کاربر'}</span></td>
                <td><span class="badge badge-${user.isActive ? 'active' : 'inactive'}">${user.isActive ? 'فعال' : 'غیرفعال'}</span></td>
                <td>${lastLogin}</td>
                <td>
                  <button class="btn btn-sm btn-warning" onclick="editUser('${user._id}')">
                    <i class="bi bi-pencil"></i>
                  </button>
                  ${user._id !== currentUser._id ? `
                    <button class="btn btn-sm btn-${user.isActive ? 'secondary' : 'success'}" onclick="toggleUserStatus('${user._id}', ${!user.isActive})">
                      <i class="bi bi-${user.isActive ? 'pause' : 'play'}"></i>
                    </button>
                  ` : ''}
                </td>
              </tr>
            `;
          });
        } else {
          tbody.innerHTML = '<tr><td colspan="6" class="text-center">کاربری یافت نشد</td></tr>';
        }
      } catch (error) {
        console.error('Load users error:', error);
      }
    }

    // Load audit logs
    async function loadAuditLogs() {
      try {
        const response = await fetch(`${API_BASE}/api/admin/audit-logs?limit=20`, { credentials: 'include' });
        const data = await response.json();
        
        const tbody = document.getElementById('auditLogsBody');
        tbody.innerHTML = '';
        
        if (data.logs && data.logs.length > 0) {
          data.logs.forEach(log => {
            const actionMap = {
              'login': 'ورود',
              'logout': 'خروج',
              'failed_login': 'ورود ناموفق',
              'create_request': 'ایجاد درخواست',
              'update_request': 'ویرایش درخواست',
              'create_user': 'ایجاد کاربر',
              'update_user': 'ویرایش کاربر',
              'upload_file': 'آپلود فایل',
              'bulk_operation': 'عملیات گروهی'
            };
            
            tbody.innerHTML += `
              <tr>
                <td><span class="badge bg-info">${actionMap[log.action] || log.action}</span></td>
                <td>${log.user?.name || 'نامشخص'}</td>
                <td>${moment(log.timestamp).locale('fa').format('YYYY/MM/DD HH:mm')}</td>
                <td><small>${JSON.stringify(log.details).substring(0, 50)}...</small></td>
              </tr>
            `;
          });
        } else {
          tbody.innerHTML = '<tr><td colspan="4" class="text-center">فعالیتی یافت نشد</td></tr>';
        }
      } catch (error) {
        console.error('Load audit logs error:', error);
      }
    }

    // Add user
    async function showAddUserModal() {
      const { value: formValues } = await Swal.fire({
        title: 'افزودن کاربر جدید',
        html:
          '<input id="swal-username" class="swal2-input" placeholder="نام کاربری">' +
          '<input id="swal-password" class="swal2-input" type="password" placeholder="رمز عبور">' +
          '<input id="swal-name" class="swal2-input" placeholder="نام و نام خانوادگی">' +
          '<select id="swal-role" class="swal2-input"><option value="user">کاربر</option><option value="admin">مدیر</option></select>',
        focusConfirm: false,
        preConfirm: () => {
          return {
            username: document.getElementById('swal-username').value,
            password: document.getElementById('swal-password').value,
            name: document.getElementById('swal-name').value,
            role: document.getElementById('swal-role').value
          };
        }
      });

      if (formValues) {
        try {
          const response = await fetch(`${API_BASE}/api/admin/users`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify(formValues)
          });
          
          const data = await response.json();
          
          if (response.ok) {
            Swal.fire('موفق!', data.message, 'success');
            loadUsers();
          } else {
            Swal.fire('خطا', data.message, 'error');
          }
        } catch (error) {
          Swal.fire('خطا', 'خطا در ایجاد کاربر', 'error');
        }
      }
    }

    // Edit user
    async function editUser(userId) {
      // Implementation similar to add user
      Swal.fire('در دست توسعه', 'این قابلیت به زودی اضافه خواهد شد', 'info');
    }

    // Toggle user status
    async function toggleUserStatus(userId, newStatus) {
      try {
        const response = await fetch(`${API_BASE}/api/admin/users/${userId}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ isActive: newStatus })
        });
        
        const data = await response.json();
        
        if (response.ok) {
          Swal.fire({
            toast: true,
            position: 'top-end',
            icon: 'success',
            title: data.message,
            showConfirmButton: false,
            timer: 2000
          });
          loadUsers();
        } else {
          Swal.fire('خطا', data.message, 'error');
        }
      } catch (error) {
        Swal.fire('خطا', 'خطا در تغییر وضعیت', 'error');
      }
    }

    // Initialize
    checkAdmin().then(isAdmin => {
      if (isAdmin) {
        loadUsers();
        loadAuditLogs();
      }
    });
  </script>
</body>
</html>

